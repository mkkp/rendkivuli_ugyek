<!DOCTYPE HTML>

{% extends "base.html" %}
{% block content %}

{% block head %}
  {% set img_url = 'https://rendkivuliugyek.site/static/upload/' + submission[0].id | string + '/' + submission[0].cover_image_full %}
<head>
  <!--MAPBOX-->
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.1/mapbox-gl.css"
    type="text/css"
  />
  <!--LIGHTBOX-->
  <link href="../static/css/lightbox.css" rel="stylesheet" />
  <!--META-->
  <title>{{ submission[0].title }}</title>
  <meta property="og:site_name" content="Rendk√≠v√ºli √úgyek Miniszt√©riuma" />
  <meta property="og:title" content="{{ submission[0].title }}" />
  {% if submission[0].solution %}
    <meta property="og:description" content="{{ submission[0].solution }}" />
  {% else %}
    <meta property="og:description" content="{{ submission[0].description }}" />
  {% endif %}
  <meta property="og:type" content="article" />
  <meta
    property="og:url"
    content="https://rendkivuliugyek.site/single_submission/{{  submission[0].id  }}"
  />
  <meta property="og:image" content="{{ img_url }}" />
  <meta property="og:locale" content="hu_HU" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  {{ super() }}
  <style>
    .submission_solution {
      display: none; //block
      overflow: hidden;
      }
    .top_image{
      width:30em;
      object-fit: cover;
     }
  </style>
</head>

 {% endblock %}
<body>

  <div class="container">
  <hr />
  <h3><b>{{ submission[0].title }}</b></h3>
  <hr />
  <a href={{ url_for('static',filename='upload/' + submission[0].id | string + '/' + submission[0].cover_image_full) }} 
     data-lightbox='roadtrip'>
    <img class="top_image img-thumbnail" 
         src={{ url_for( 'static',filename='upload/' + submission[0].id | string + '/' + submission[0].cover_image_full) }}/>
  </a>
  <br />
  <br />
  {%if submission[0].featured == True %}
    <p><strong> Kiemelt √ºgy </strong></p>
  {% endif %}        
  <p><strong>Le√≠r√°s:</strong> {{ submission[0].description }}</p>
  <p><strong>Megold√°si javaslat:</strong> {{ submission[0].suggestion }}</p>
  <p><strong>St√°tusz:</strong> {{ submission[0].status }}</p>
  <p><strong>Ebben a st√°tuszban:</strong> {{ submission[0].status_changed_date }}</p>
  <p><strong>T√≠pus:</strong> {{ submission[0].problem_type }}</p>
  <p><strong>Bejelentve:</strong> {{ submission[0].created_date }}</p>
  <p><strong>Megye:</strong> {{ submission[0].county }}</p>
  <p><strong>C√≠m:</strong> {{ submission[0].address }}</p>

  {%if submission[0].owner_email %}
    <p><strong>Szervez≈ë:</strong> {{ submission[0].owner_email }}</p>
  {% endif %}
        
  {%if submission[0].solution %}
    <p><strong>Z√°r√≥ sz√∂veg:<br>
    </strong>{{ submission[0].solution }}</p>
  {% endif %}
         
  {% if submission[0].status != 'Befejezve' 
     and submission[0].status != 'Inakt√≠v' 
     and submission[0].status != 'Duplika'
     and submission[0].status != 'Hivatal megoldotta'
  %}
    <p>Ha szeretn√©l r√©sztvenni a fel√∫j√≠t√°sban, √≠rj nek√ºnk a
    <a href="mailto: kovacs.gergely@mkkp.hu?subject=V√°rosfel√∫j√≠t√≥s jelentkez√©s: {{ submission[0].title }} id:{{ submission[0].id }}">
     <strong>kovacs.gergely@mkkp.hu</strong>
    </a>email c√≠mre!</p>
  {% endif %}     
        
  {% if current_user.email == submission[0].owner_email
     or role == 'coordinator' 
     or role == 'admin'
  %}
        
    <a href="/change_submission_data/{{ submission[0].id }}">
      <button class="btn btn-light form-control rounded-0">Adatok m√≥dos√≠t√°sa</button>
    </a>
    <br />
    <br />
  {% endif %}      
  <div id="fb-root"></div>
    <div class="fb-share-button" 
         data-href="https://rendkivuliugyek.site/single_submission/{{  submission[0].id  }}" 
	 data-layout="button_count">
    </div>
    <hr /> 
        
    <!--EL≈êTTE K√âPEK FELT√ñLT√âSE-->
  {% if current_user.email == submission[0].submitter_email
     or current_user.email == submission[0].owner_email
     or role == 'coordinator' 
     or role == 'admin'
  %}
    <form action="" method="post" enctype="multipart/form-data">
      <div class="form-group">
        <input type="file" 
               id="files" 
               name="files" 
               class="btn rounded-0" 
               multiple="true" 
               required 
        />
        <button type="submit" 
                id="upload_before_images" 
                name="upload_before_images" 
                class="btn rounded-0">El≈ëtte K√©pek felt√∂lt√©se
        </button>
      </div>
    </form>

    <form action="" method="post" enctype="multipart/form-data">
      <div class="form-group">
        <input hidden 
               type=text 
               value={{current_user.user_name}} 
               name="current_user" 
        />
        <input type="file" 
               id="files" 
               name="files" 
               class="btn rounded-0" 
               multiple="true" 
               required 
        />
        <button type="submit" 
                id="upload_after_images" 
                name="upload_after_images" 
                class="btn rounded-0">Ut√°na K√©pek felt√∂lt√©se
        </button>
      </div>
    </form>
  {% endif %}
        
  <form action="" method="post">
  <!--EL≈êTTE K√âPEK MUTAT√ÅSA-->
    {% if before_img_list.count() >= 1 %}
      <h4>El≈ëtte k√©pek:</h4>
      {% for img in before_img_list %}
        {% if submission[0].cover_image != img.thumb_file_name%}
          <figure class="figure">
            <a href={{ url_for( 'static',filename='upload/' + submission[0].id | string + '/' + img.file_name) }} data-lightbox='roadtrip'>
              <img height="200px" src={{ url_for( 'static',filename='upload/' + submission[0].id | string + "/" + img.thumb_file_name) }}/>
            </a>
            {% if current_user.email == submission[0].submitter_email
               or current_user.email == submission[0].owner_email
               or role == 'coordinator'
               or role == 'admin'
             %}
              <figcaption>
                <label for="thumbnail"> Bor√≠t√≥ k√©pp√©</label>
                <input type="checkbox" 
                       name="new_thumb" 
                       value={{ img.thumb_file_name }}>
                <label> T√∂rl√©s: </label>
                <a href="/delete_picture/before/{{img.id}}">üóë</a>
              </figcaption>
            {% endif %}
          </figure>
        {% endif %}
      {% endfor %}
    {% endif %}

   <!--UT√ÅNA K√âPEK-->
   {% if after_img_list[0] %}
     <br />
     <h4>Ut√°na k√©pek:</h4>
     <br /> 
     {% for img in after_img_list %}
       <figure class="figure">
         <a href={{url_for( 'static',filename='upload/' + submission[0].id | string + "/" + img.file_name)}} data-lightbox='roadtrip'>
           <img height="200px" 
                src={{url_for( 'static',filename='upload/' + submission[0].id | string + "/" + img.thumb_file_name)}}/>
         </a>
         {% if current_user.email == submission[0].submitter_email
            or current_user.email == submission[0].owner_email
            or role == 'coordinator' 
            or role == 'admin'
         %}
           <figcaption>
             <label for="thumbnail"> Bor√≠t√≥ k√©pp√©</label>
             <input type="checkbox" name="new_thumb" value={{img.thumb_file_name}}>
             <label> T√∂rl√©s: </label>
             <a href="/delete_picture/before/{{img.id}}">üóë</a>
           </figcaption>  
         {% endif %}
       </figure>
     {% endfor %}
   {% endif %}
        
   {% if current_user.email == submission[0].submitter_email
      or current_user.email == submission[0].owner_email
      or role == 'coordinator' 
      or role == 'admin'
   %}
     {% if before_img_list.count() >= 1 
        or after_img_list.count() >= 1
     %}
       <br />
       <button type="submit" 
               id="change_tumbnail" 
               name="change_tumbnail" 
               class="btn rounded-0">Bor√≠t√≥k√©p m√≥dos√≠t√°sa</button> 
       <br />
       <br />
     {% endif %}
   {% endif %}
 </form>
     
 {% if comment_list[0] %}
   <hr />
   <label for="comment">Kor√°bbi hozz√°sz√≥l√°sok</label>
   <br />
 {% endif %}
   {% for comment in comment_list %}
     {% if comment.commenter == current_user.user_name or role == 'admin' %}
       <a href="/delete_comment/{{comment.id}}">
         <button class="btn btn-danger rounded-0" 
                 id="comment-delete" 
                 name="comment-delete">t√∂rl√©s</button>
       </a>
        {% endif %}

       <p style="color: black; background: MediumSeaGreen; padding:0.3em">
         <strong>{{ comment.commenter}} | {{ comment.created_date}}</strong>
       </p>
        
       {% if comment.commenter == current_user.user_name or role == 'admin' %}
         <form action="" method="post">
           <p>{{ comment.body }}</p>
           <input class="form-control rounded-0" 
                  id="comment" 
                  rows="1" 
                  name="comment" 
                  style="padding:0.2em; word-wrap: break-word;"
                  value='{{ comment.body }}'/>

           <button class="btn btn-warning rounded-0" 
                    id="comment-edit" 
                    name="comment-edit">szerkeszt√©s ment√©se
           </button>
           <input hidden type=text 
                   value={{comment.id}} 
                   name="comment_id" 
           />
         </form>
         {% else %}
         <blockquote disabled 
                     class="form-control rounded-0" 
                     id="comment" 
                     rows="1" 
                     name="comment" 
                     style="padding:0.2em; word-wrap: break-word;">
                     {{ comment.body }}
         </blockquote>
       {% endif %}
       <br /> 
     {% endfor %} 
     
     {% if current_user.is_authenticated %}
       <form action="" method="post">
         <input hidden type=text 
                value='{{current_user.user_name}}' 
                name="current_user" />
         <label for="comment">Na ehhez hozz√°sz√≥lok √©n is!</label>

         <input type=text 
                class="form-control rounded-0" 
                id="comment" 
                rows="1" 
                name="comment"
         />
         <br />
         <button type="submit" 
                 id="comment-submit" 
                 name="comment-submit" 
                 class="btn btn-primary rounded-0">
                 Hozz√°asz√≥l√°s bek√ºld√©se
         </button>
       </form>
       <hr /> 
     {% endif %}
        
     {% if role == 'coordinator' or role == 'admin' %}
       <a href="/assign/{{submission[0].id}}" rel="noopener noreferrer">
         <button type="button" 
                 class="btn btn-success form-control rounded-0">
                 Szervez≈ët adok a bejelent√©shez!
         </button>
       </a>
     {% endif %}
     
     <hr />
        
     <div id='map' 
          style='width: auto; height: 30em;'>
     </div>

     <a href="https://www.google.com/maps/@{{submission[0].lat}},{{submission[0].lng}},17z" 
        target="_blank" 
        rel="noopener noreferrer">
       <p>Mutasd ugyanezt Google t√©rk√©pen!</p>
     </a>

     {% if current_user.email == submission[0].owner_email 
        or role == 'coordinator' 
        or role == 'admin' %}
        
     <br />
        
     <a href="/delete_submission/{{submission[0].id}}">
       <button class="btn btn-danger form-control rounded-0">Bejelent√©s t√∂rl√©se!
       </button>
     </a>
   {% endif %}
   <hr />
   <br />
   <br />
 </div>
    
 <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>   
 <script src="../static/js/lightbox.js"></script>
    
 <script>
   mapboxgl.accessToken = '{{ACCESS_KEY}}';
   var map = new mapboxgl.Map({
   container: 'map',
   center: [{{submission[0].lng}}, {{submission[0].lat}}],
   zoom: 13,
   minZoom:5,
   style: 'mapbox://styles/mapbox/streets-v11',
   });
   
   map.on('load', () => {
   var status_dict = {
     'Befejezve': 'befejezve',
     'Bejelentve': 'bejelentve',
     'Duplika': 'szurke',
     'Folyamatban': 'folyamatban',
     'Hivatal megoldotta': 'szurke',
     'Inakt√≠v': 'szurke',
     'K√©sz√ºl': 'keszul'
     };

   var type_dict = {
     'Akad√°lymentes√≠t√©s': 'akadalymentesites',
     '√Ållat': 'allat',
     'K√∂zleked√©s': 'kozlekedes',
     'K√∂zm≈±': 'kozmu',
     'Egy√©b': 'egyeb',
     '√âp√ºlet': 'epulet',
     'N√∂v√©ny': 'noveny',
     'M≈±eml√©k': 'muemlek',
     'Szem√©t': 'szemet',
     'T√°j√©koztat√°s': 'tajekoztatas',
     'Utcab√∫tor':'utcabutor',
     '√öt √©s J√°rda': 'ut_es_jarda'
     };
     
   const status = status_dict['{{ submission[0].status }}']
   const submission_type = type_dict['{{ submission[0].problem_type }}']
   const img_path = "{{url_for( 'static',filename='marker/')}}" +
	                 status +
	                 "/" +
	                 submission_type+
	                 ".png"
             
   map.loadImage(img_path,
   (error, image) => {
     if (error) throw error;
     map.addImage('custom-marker', image);
	    
     // Add a GeoJSON source with 2 points
     map.addSource('points', {
       'type': 'geojson',
       'data': {
         'type': 'FeatureCollection',
         'features': [{
         'type': 'Feature',
          'properties': {},
          'geometry': {
            'type': 'Point',
            'coordinates': [{{submission[0].lng}}, {{submission[0].lat}}]
          }
         }
         ]
       }
     }
     )

     // Add a symbol layer
     map.addLayer({
       'id': 'points',
       'type': 'symbol',
       'source': 'points',
       'layout': {
       'icon-image': 'custom-marker',
       }
     })}
     ) //loadImage
     });//on load

    map.addControl(new mapboxgl.NavigationControl());
    map.addControl(new mapboxgl.FullscreenControl());
	
  </script>
    
  <script>
  //Facebook share button
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0";
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
  </script>

  <script>
    lightbox.option({
      'resizeDuration': 100,
      'wrapAround': true,
      'alwaysShowNavOnTouchDevices':false,
      'albumLabel':"%1 / %2"
    })
  </script>

</body>

{% endblock %}
