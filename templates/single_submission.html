{% extends "base.html" %} 
{% block content %}
 {% block head %}
  {% set img_url = 'https://rendkivuliugyek.site/static/upload/' + submission[0].id | string + '/' + before_img_list[0].file_name%}
  <head>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css' rel='stylesheet' />    
    <title>{{ submission[0].title }}</title>
    <meta property="og:site_name"      content="Rendk√≠v√ºli √úgyek Miniszt√©riuma" />  
    <meta property="og:title"          content="{{ submission[0].title }}" />
    <meta property="description"       content="{{ submission[0].description }}" />
    <meta property="og:description"    content="{{ submission[0].description }}" />
    <meta property="og:type"           content="article" />
    <meta property="og:url"            content="https://rendkivuliugyek.site/single_submission/{{  submission[0].id  }}" />
    <meta property="og:image"          content="{{ img_url }}" />
    <meta property="og:locale"         content="hu_HU" />
    
    {{ super() }}
  <style>
  .submission_solution {
    display: none; //block 
    overflow: hidden;
    }
  </style>
  </head>
 {% endblock %}
<body>

    <div class="container">
        <hr>
        <h3><b>{{ submission[0].title }}</b></h3>
        <hr>
        <p><strong>Le√≠r√°s:</strong> {{ submission[0].description }}</p>

        <p><strong>Megold√°si javaslat:</strong> {{ submission[0].suggestion }}</p>
        
        {% if current_user.email == submission[0].owner_email
           or role == 'coordinator' 
           or role == 'admin'
        %}

        <form action="" method="post">
            <input hidden type=text, value={{current_user.user_name}} name="current_user" />
            <label for="status"><strong>St√°tusz</strong></label>
            <select class="form-select" id="status" aria-label="Select status" name="status" onchange="detectChange(this)">
	     <option selected>{{ submission[0].status }}</option>
	     <option value="Folyamatban">Folyamatban</option>
	     <option value="K√©sz√ºl">K√©sz√ºl</option>
	     <option value="Hivatal megoldotta">Hivatal megoldotta</option>	     
	     <option value="Inakt√≠v">Inakt√≠v</option>
	     <option value="Duplika">Duplika</option>
	     <option value="Befejezve">Befejezve</option>
	    </select>
            <button type="submit" id="change_status" name="change_status" class="btn btn-primary rounded-0">M√≥dos√≠t</button>
        </form>

        {% else %}

        <p><strong>St√°tusz:</strong> {{ submission[0].status }}</p>

        {% endif %}
        
        <p><strong>Ebben a st√°tuszban:</strong> {{ submission[0].status_changed_date }}</p>
        <p><strong>T√≠pus:</strong> {{ submission[0].problem_type }}</p>
        <p><strong>Bejelentve:</strong> {{ submission[0].created_date }}</p>
        <p><strong>Megye:</strong> {{ submission[0].county }}</p>
        
        {% if current_user.email == submission[0].submitter_email
           or current_user.email == submission[0].owner_email
           or role == 'coordinator' 
           or role == 'admin'
        %}
        <p><strong>C√≠m:</strong> {{ submission[0].address }}</p>
        
          <form action="" method="post">
          <label><strong>C√≠m m√≥dos√≠t√°sa:</strong></label>
          <input type="text" class="form-control rounded-0" id="new_address" autocomplete="on" name="new_address">
          <input hidden type="text" id="lng" name="lng" value=0></p> <!--Ide lehetne valami vicces default √©rt√©ket adni, pl parlament-->
          <input hidden type="text" id="lat" name="lat" value=0></p> <!--Ide lehetne valami vicces default √©rt√©ket adni, pl parlament-->
          <input hidden type="text" id="city" name="city" value="nem meghat√°rozott"></p>
          <input hidden type="text" id="county" name="county" value="nem meghat√°rozott"></p>          
          <button type ="button" 
                  class="btn btn-warning rounded-0" 
                  id="complete_addr" 
                  name="complete_addr" 
                  onclick="complete_address()">C√≠m kieg√©sz√≠t√©se</button>
          <button class="btn btn-warning rounded-0" id="new_address_submit" name="new_address_submit">√öj C√≠m ment√©se</button>
          </form>
          
        {% else %}
        <p><strong>C√≠m:</strong> {{ submission[0].address }}</p>
        {% endif %}
        
        {%if submission[0].owner_email %}
         <p><strong>Rendez≈ë:</strong> {{ submission[0].owner_email }}</p>
        {% endif %}
        
        {%if submission[0].solution %}
         <p><strong>Z√°r√≥ sz√∂veg:<br>
         </strong>{{ submission[0].solution }}</p>
        {% endif %}
        
        <!--√úGY BEFEJEZVE SZ√ñVEG-->
        <div class = "submission_solution" id = "solution_div">
        <form action="" method="post" enctype="multipart/form-data">
          <label><strong>Megold√°s</strong></label>
          <input hidden type=text, value={{current_user.user_name}} name="current_user" />
          <textarea class="form-control rounded-0" id="solution" rows="3" name="closing_solution"></textarea>
          <button class="btn btn-warning rounded-0" name="closing_solution_submit" id="closing_solution_submit">Megold√°s hozz√°ad√°sa</button>
        </form>
        </div>
        <!--√úGY BEFEJEZVE SZ√ñVEG--> 

        <div id="fb-root"></div>
	<div class="fb-share-button" 
	  data-href="https://rendkivuliugyek.site/single_submission/{{  submission[0].id  }}" 
	  data-layout="button_count">
	</div>
        <hr> 
        <!--EL≈êTTE K√âPEK FELT√ñLT√âSE-->
        {% if current_user.email == submission[0].submitter_email
           or current_user.email == submission[0].owner_email
           or role == 'coordinator' 
           or role == 'admin'
        %}
        <form action="" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <input type="file" id="files" name="files" class="btn rounded-0" multiple="true" autocomplete="off" required />
                <button type="submit" id="upload_before_images" name="upload_before_images" class="btn rounded-0">El≈ëtte K√©pek felt√∂lt√©se
            </button>
            </div>
        </form>

        <form action="" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <input type="file" id="files" name="files" class="btn rounded-0" multiple="true" autocomplete="off" required />
                <button type="submit" id="upload_after_images" name="upload_after_images" class="btn rounded-0">Ut√°na K√©pek felt√∂lt√©se
            </button>
            </div>
        </form>

        {% endif %}
        
        <form action="" method="post">
        <!--EL≈êTTE K√âPEK MUTAT√ÅSA-->
        <h4>El≈ëtte k√©pek:</h4>
        <br> {% for img in before_img_list %}
        <figure class="figure">
            <a href={{url_for( 'static',filename='upload/' + submission[0].id | string + '/' + img.file_name)}}>
                <img src={{url_for( 'static',filename='upload/' + submission[0].id | string + "/" + img.thumb_file_name)}}/>
            </a>
             {% if current_user.email == submission[0].submitter_email
                or current_user.email == submission[0].owner_email
                or role == 'coordinator' 
                or role == 'admin'
              %}
             {% if submission[0].cover_image == img.thumb_file_name%}
               <figcaption>‚òùJelenlegi bor√≠t√≥k√©p</figcaption>
             {% else %}
               <figcaption>
               <label for="thumbnail"> Bor√≠t√≥ k√©pp√©</label>
               <input type="checkbox" name="new_thumb" value={{img.thumb_file_name}}>
               <label> T√∂rl√©s: </label>
               <a href="/delete_picture/before/{{img.id}}">üóë</a>
               </figcaption>
               </figure>
             {% endif %}
            {% endif %}
        </figure>
        {% endfor %}

        <br>
        <!--UT√ÅNA K√âPEK-->
        <h4>Ut√°na k√©pek:</h4>
        
        <br> 
        {% for img in after_img_list %}
         <figure class="figure">
            <a href={{url_for( 'static',filename='upload/' + submission[0].id | string + "/" + img.file_name)}}>
                <img src={{url_for( 'static',filename='upload/' + submission[0].id | string + "/" + img.thumb_file_name)}}/>
            </a>
             {% if current_user.email == submission[0].submitter_email
                or current_user.email == submission[0].owner_email
                or role == 'coordinator' 
                or role == 'admin'
              %}
               {% if submission[0].cover_image == img.thumb_file_name%}
                 <figcaption>‚òùJelenlegi bor√≠t√≥k√©p</figcaption>
               {% else %}
                 <figcaption>
                 <label for="thumbnail"> Bor√≠t√≥ k√©pp√©</label>
                 <input type="checkbox" name="new_thumb" value={{img.thumb_file_name}}>
                 <label> T√∂rl√©s: </label>
                 <a href="/delete_picture/before/{{img.id}}">üóë</a>
                 </figcaption>
               {% endif %}
            {% endif %}
         </figure>
        {% endfor %}
        <br>
        <button type="submit" id="change_tumbnail" name="change_tumbnail" class="btn rounded-0">Bor√≠t√≥k√©p m√≥dos√≠t√°sa</button>
        
        </form>        
        <br>
        <hr>
        {% if comment_list[0] %}
        <label for="comment">Kor√°bbi hozz√°sz√≥l√°sok</label>
        {% endif %}
        <br> {% for comment in comment_list %} 
        {% if comment.commenter == current_user.user_name or role == 'admin' %}
        <a href="/delete_comment/{{comment.id}}">
            <button class="btn btn-danger rounded-0" id="comment-delete" name="comment-delete">t√∂rl√©s</button>
        </a>
        {% endif %}

        <p style="color: black; background: MediumSeaGreen; padding:0.3em">
            <strong>{{ comment.commenter}} | {{ comment.created_date}}</strong>
        </p>
        
        {% if comment.commenter == current_user.user_name or role == 'admin' %}
        <form action="" method="post">
            <textarea class="form-control rounded-0" id="comment" rows="1" name="comment" style="padding:0.2em; word-wrap: break-word;">
              {{ comment.body }}
             </textarea>
            <button class="btn btn-warning rounded-0" id="comment-edit" name="comment-edit">szerkeszt√©s ment√©se</button>
            <input hidden type=text, value={{comment.id}} name="comment_id" />
        </form>
        {% else %}
        <blockquote disabled class="form-control rounded-0" id="comment" rows="1" name="comment" style="padding:0.2em; word-wrap: break-word;">
            {{ comment.body }}
        </blockquote>
        {% endif %}
        <br> 
        {% endfor %} 
        {% if current_user.is_authenticated %}
         <form action="" method="post">
            <input hidden type=text, value='{{current_user.user_name}}' name="current_user" />
            <label for="comment">Na ehhez hozz√°sz√≥lok √©n is!</label>

            <textarea class="form-control rounded-0" id="comment" rows="1" name="comment"></textarea>
            <br>
            <button type="submit" id="comment-submit" name="comment-submit" class="btn btn-primary rounded-0">Hozz√°asz√≥l√°s bek√ºld√©se
            </button>
         </form>
         <hr> 
        {% endif %}
        
         {% if role == 'coordinator' or role == 'admin' %}
         <a href="/assign/{{submission[0].id}}" rel="noopener noreferrer">
            <button type="button" class="btn btn-success form-control rounded-0">Rendez≈ët adok a bejelent√©shez!</button>
         </a>
         {% endif %}          

        <hr>
        
        <div id='map' style='width: auto; height: 30em;'></div>

        <a href="https://www.google.com/maps/@{{submission[0].lat}},{{submission[0].lng}},17z" target="_blank" rel="noopener noreferrer">
            <p>De nekem a Google Maps kell!</p>
        </a>

        {% if current_user.email == submission[0].owner_email or role == 'coordinator' or role == 'admin' %}
        
        <br>
        
        <a href="/delete_submission/{{submission[0].id}}">
            <button class="btn btn-danger form-control rounded-0">Bejelent√©s t√∂rl√©se!</button>
        </a>
        {% endif %}
        <hr>
        <br>
        <br>
    </div>
    
    <script>
        mapboxgl.accessToken = '{{ACCESS_KEY}}';
        var map = new mapboxgl.Map({
        container: 'map',
        center: [{{submission[0].lng}}, {{submission[0].lat}}],
        zoom: 13,
        style: 'mapbox://styles/mapbox/streets-v11' //'mapbox://styles/mapbox/navigation-night-v1'
        });
    
        map.on('load', () => {
        map.addSource('points', {
         'type': 'geojson',
         'data': {
         'type': 'FeatureCollection',
         'features': [
         {
         'type': 'Feature',
         'properties': {},
         'geometry': {
         'type': 'Point',
         'coordinates': [{{submission[0].lng}}, {{submission[0].lat}}]
         }}]}
        });
    
        // Add a circle layer
        map.addLayer({
         'id': 'circle',
         'type': 'circle',
         'source': 'points', //refers to first parameter of addSource
         'paint': {
         'circle-color': '#ff0000',
         'circle-radius': 10,
         'circle-stroke-width': 2,
         'circle-stroke-color': '#000000'
         }})
        });
    </script>
    
    <script>
        (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
	if (d.getElementById(id)) return;
	js = d.createElement(s); js.id = id;
	js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0";
	fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));
    </script>

   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<script>
function detectChange(status) {
  var content = document.getElementById("solution_div");
  if (status.value === "Befejezve") {
    if (content.style.display === "block") {
        content.style.display = "none";
       } else {
        content.style.display = "block";
       }       
     }
  };

</script>

<script>
  //C√çM KIEG√âSZ√çT√âSE
  function complete_address(){
  //FW GEOCODING COMPLETION
  var address_input = document.getElementById("new_address").value;
  console.log(address_input)
  url = "https://api.mapbox.com/geocoding/v5/mapbox.places/" + 
  address_input +
  ".json?country=hu" +
  "&proximity=-73.990593%2C40.740121" +
  "&types=place%2Cpostcode%2Caddress" +
  "&language=hu" +
  "&access_token={{ACCESS_KEY}}"
  $.get(url, function (data) {
    var location_center = data.features[0].center;
    var lat = data.features[0].center[1]
    var lng = data.features[0].center[0]
    var address = data.features[0]['place_name']
    var city = address.split(",")[0].trim()
  
    if (city == "Budapest"){ 
      var county = "Budapest"
    } else {
      var county = address.split(",")[3].trim()
    };
  
    var county = county.replace("megye", "")
    
    document.getElementById("new_address").value = address
    document.getElementById("city").value = city
    document.getElementById("county").value = county
    document.getElementById("lng").value = lng
    document.getElementById("lat").value = lat
  
    deletePopup();
    addPopup(lng, lat, address);
    deleteLayer();
    deleteSource();
    addSource(lng,lat);
    addLayer();
    map.flyTo({center: [lng,lat]});
  
})};
</script>

<script>
//UTILS
function deleteSource(){
    if (map.getSource('points')) {
      map.removeSource('points')
    }
};

function deleteLayer(){
    if (map.getLayer('circle')) {
      map.removeLayer('circle')
    }
};

function addSource(lng,lat){
    map.addSource('points', {
    'type': 'geojson',
    'data': {
      'type': 'FeatureCollection',
      'features': [
        {
        'type': 'Feature',
        'properties': {},
        'geometry': {
          'type': 'Point',
          'coordinates': [lng,lat]
          }
        }
      ]
    }
    });
};

function addLayer(){
	map.addLayer({
	    'id': 'circle',
	    'type': 'circle',
	    'source': 'points', //refers to first parameter of addSource
	    'paint': {
	      'circle-color': '#ff0000',
	      'circle-radius': 10,
	      'circle-stroke-width': 2,
	      'circle-stroke-color': '#000000',
	      'circle-opacity' : 0.5
	    }})    
};

//DELETE POPUP
function deletePopup(){
  const popups = document.getElementsByClassName("mapboxgl-popup");
  if (popups.length) { 
    popups[0].remove() 
    }
};

//ADD POPUP
function addPopup(lng, lat, address){
    const popup = new mapboxgl.Popup({ closeOnClick: false })
    .setLngLat([lng,lat])
    .setHTML(`<p>${address}</p>`)
    .addTo(map);
}

//<--UTILS
</script>

</body>

{% endblock %}
